# ADR-001: モノレポツールの選定

- Status: Accepted
- Date: 2025-07-19
- Deciders: [@maskatsuy]

## コンテキスト
本プロジェクトでは、フロントエンド、BFF、複数のバックエンドサービスを効率的に管理する必要がある。これらのサービスは相互に依存関係を持ち、統一的な開発・ビルド・デプロイプロセスが求められる。

### 要件
1. 複数のTypeScript/JavaScriptプロジェクトとRustプロジェクトの共存
2. 依存関係の効率的な管理
3. ビルド・テストの並列実行によるCI/CD時間の短縮
4. 開発者体験（DX）の向上
5. キャッシュによるビルド時間の最適化

## 検討した選択肢

### 1. Lerna + Yarn Workspaces
- **利点**: 成熟したエコシステム、豊富なドキュメント
- **欠点**: パフォーマンスの問題、並列実行の制限、開発が停滞気味

### 2. Nx
- **利点**: 高度なキャッシュ機能、優れた可視化ツール、プラグインエコシステム
- **欠点**: 学習曲線が急、設定が複雑、小〜中規模プロジェクトにはオーバースペック

### 3. Rush
- **利点**: Microsoftによる開発、エンタープライズ向け機能
- **欠点**: 設定が複雑、コミュニティが小さい、主にMicrosoft製品向け

### 4. Turborepo + pnpm
- **利点**: 
  - 高速な並列実行とインテリジェントなキャッシュ
  - シンプルな設定（turbo.json）
  - pnpmとの組み合わせでディスク容量を節約
  - Vercelによる積極的な開発
  - TypeScriptプロジェクトに最適化
- **欠点**: 
  - 比較的新しいツール（ただし、Vercelがバックにいるため安定）
  - Rustプロジェクトのサポートは限定的：
    - `target`ディレクトリのキャッシュ設定が手動
    - Cargoワークスペースとの統合が未サポート
    - ビルド成果物のパスがJavaScriptプロジェクトと異なる
    - カスタムタスクでのラッパー実装が必要

## 決定
**Turborepo + pnpm** を採用する。

## 理由
1. **パフォーマンス**: リモートキャッシュとローカルキャッシュにより、CI/CD時間を大幅に削減
2. **シンプルさ**: 設定が直感的で、小規模から始めて段階的に拡張可能
3. **pnpmとの相性**: ワークスペースプロトコルとシンボリックリンクによる効率的な依存関係管理
4. **開発の活発さ**: Vercelによる継続的な改善とNext.jsエコシステムとの統合
5. **移行の容易さ**: 将来的に他のツールへの移行が必要になっても、標準的なnpmワークスペース構造のため移行が容易

## 実装方針
1. pnpm-workspace.yamlでワークスペースを定義
2. turbo.jsonで並列実行とキャッシュ戦略を設定
3. 各サービスは独立したpackage.jsonを持つ
4. 共通の設定やユーティリティはpackages/ディレクトリに配置
5. Rustプロジェクトはturbo.jsonのカスタムタスクで統合

## 影響
- **ポジティブ**: 
  - 開発効率の向上
  - CI/CD時間の短縮
  - 依存関係の明確化
- **ネガティブ**: 
  - チームメンバーの学習コスト（ただし、Turborepoは学習曲線が緩やか）
  - Rustプロジェクトとの統合に追加作業が必要

## 参考資料
- [Turborepo公式ドキュメント](https://turbo.build/repo/docs)
- [pnpm公式ドキュメント](https://pnpm.io/)
- [Monorepo.tools - ツール比較](https://monorepo.tools/)